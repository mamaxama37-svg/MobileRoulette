<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Roulette Smart Analyzer</title>
<style>
body { margin:0; font-family:sans-serif; background:#000; color:#fff; text-align:center; }
header { background:#111; padding:12px; font-size:1.4em; }
#canvasContainer { position: relative; width:100%; max-width:600px; margin:auto; }
canvas { width:100%; border:2px solid #fff; display:block; }
#stats { margin-top:10px; font-size:1em; }
#stats div { margin:4px 0; }
#controls { margin:10px; }
button { padding:8px 12px; margin:4px; font-size:1em; }
</style>
</head>
<body>

<header>Live Roulette Smart Analyzer</header>

<div id="canvasContainer">
<canvas id="overlay"></canvas>
<video id="video" autoplay muted playsinline style="display:none;"></video>
</div>

<div id="stats">
  <div>Last Numbers: <span id="lastNumbers">--</span></div>
  <div>Ball Speed (rad/s): <span id="ballSpeed">--</span></div>
  <div>Physics Prediction: <span id="physicsPred">--</span></div>
  <div>Final Prediction + Neighbor: <span id="finalPred">--</span></div>
</div>

<div id="controls">
  <input type="file" accept="image/*" id="screenshot">
  <button onclick="loadScreenshot()">Load Screenshot (Optional)</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
// --- WHEEL MODEL ---
const wheel = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,
               30,8,23,10,5,24,16,33,1,20,14,31,9,
               22,18,29,7,28,12,35,3,26];

let lastNumbers = [];
let overlay = document.getElementById('overlay');
let ctx = overlay.getContext('2d');
let video = document.getElementById('video');

let prevAngle = null, prevTime = null, ballSpeed = 0;

// --- CAMERA SETUP ---
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment", width:640, height:480 }
}).then(stream => {
  video.srcObject = stream;
}).catch(err=>alert("Camera error: "+err));

// --- BALL DETECTION ---
function detectBall(frameCtx){
  const w = overlay.width;
  const h = overlay.height;
  const data = frameCtx.getImageData(0,0,w,h).data;
  for(let i=0;i<data.length;i+=4){
    const r=data[i], g=data[i+1], b=data[i+2];
    if(r>200 && g>200 && b>200){ // bright ball, adjust threshold
      const x=(i/4)%w;
      const y=Math.floor(i/4/w);
      return {x,y};
    }
  }
  return null;
}

// --- BALL TRACKING ---
function trackBall(ball){
  const cx = overlay.width/2, cy = overlay.height/2;
  const angle = Math.atan2(ball.y-cy, ball.x-cx);
  const now = performance.now();
  if(prevAngle !== null){
    const dt = (now-prevTime)/1000;
    ballSpeed = (angle-prevAngle)/dt;
  }
  prevAngle = angle;
  prevTime = now;
}

// --- PHYSICS PREDICTION ---
function predictLandingFromBall(ball){
  if(!ball) return null;
  const cx = overlay.width/2, cy = overlay.height/2;
  const angle = Math.atan2(ball.y-cy, ball.x-cx);
  const decel = 0.05;
  const segmentsLeft = Math.round(ballSpeed*ballSpeed/(2*decel));
  // Map angle to closest wheel segment
  const segmentSize = 2*Math.PI / wheel.length;
  let currentIndex = Math.floor((angle + Math.PI) / segmentSize) % wheel.length;
  if(currentIndex<0) currentIndex+=wheel.length;
  return wheel[(currentIndex+segmentsLeft+wheel.length)%wheel.length];
}

// --- COMBINE STATISTICS + PHYSICS ---
function combinePrediction(physicsPred){
  if(lastNumbers.length===0) return;
  const counts = {};
  lastNumbers.forEach(n => counts[n] = (counts[n]||0)+1);
  let topNumber = parseInt(Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b));

  // Choose physics prediction if it aligns with hot numbers
  let final = physicsPred && lastNumbers.includes(physicsPred)? physicsPred : topNumber;
  const idx = wheel.indexOf(final);
  const neighbor = wheel[(idx+1)%wheel.length];

  document.getElementById('physicsPred').innerText = physicsPred||"--";
  document.getElementById('finalPred').innerText = final+" | Neighbor: "+neighbor;
}

// --- OCR FOR CURRENT NUMBER ---
async function readNumberFromVideo(){
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = overlay.width;
  tempCanvas.height = overlay.height;
  const tempCtx = tempCanvas.getContext('2d');
  tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);

  // Adjust this region to match your camera view
  const regionX = tempCanvas.width-100;
  const regionY = 10;
  const regionW = 80;
  const regionH = 50;
  const imageData = tempCtx.getImageData(regionX, regionY, regionW, regionH);

  try{
    const res = await Tesseract.recognize(imageData, 'eng');
    let num = parseInt(res.data.text.replace(/\D/g,''));
    if(!isNaN(num) && num>=0 && num<=36){
      if(lastNumbers[lastNumbers.length-1] !== num){
        lastNumbers.push(num);
        if(lastNumbers.length>100) lastNumbers.shift();
        document.getElementById('lastNumbers').innerText = lastNumbers.join(", ");
      }
    }
  }catch(e){}
}

// --- MAIN LOOP ---
function loop(){
  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;
  ctx.drawImage(video,0,0,overlay.width,overlay.height);

  const ball = detectBall(ctx);
  if(ball) trackBall(ball);

  const physicsPred = predictLandingFromBall(ball);
  combinePrediction(physicsPred);

  readNumberFromVideo(); // OCR
  document.getElementById('ballSpeed').innerText = ballSpeed.toFixed(2);

  requestAnimationFrame(loop);
}

video.onloadedmetadata = () => loop();

// --- OPTIONAL: LOAD SCREENSHOT ---
function loadScreenshot(){
  const file = document.getElementById('screenshot').files[0];
  if(!file) return alert("Select a file");
  const img = new Image();
  img.onload = ()=>ctx.drawImage(img,0,0,overlay.width,overlay.height);
  img.src = URL.createObjectURL(file);
}
</script>
</body>
</html>
