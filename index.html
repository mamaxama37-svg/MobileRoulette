<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Roulette Analyzer (Back Camera)</title>
<style>
body { background:#000; color:#fff; font-family:Arial; text-align:center; margin:0; }
header { background:#111; padding:12px; font-size:1.2em; }
video { width:95%; border:2px solid #fff; margin:5px 0; }
#results { margin-top:10px; }
.result { font-size:1.1em; margin-top:6px; }
.hot { color:#ff5555; font-weight:bold; }
.good { color:#ffaa00; }
.ok { color:#66ccff; }
</style>
</head>
<body>

<header>Mobile Roulette Analyzer</header>

<video id="rouletteVideo" autoplay muted playsinline></video>

<div id="results">
  <div class="result" id="mainNumber">Main Number: --</div>
  <div class="result" id="neighbor">Top Neighbor: --</div>
  <div class="result" id="probabilities">Top Numbers: --</div>
  <div class="result" id="confidence">Confidence: --</div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
const wheel=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,
30,8,23,10,5,24,16,33,1,20,14,31,9,
22,18,29,7,28,12,35,3,26];

let history=[];
let prevAngle=null, prevTime=null, currentSpeed=0;

// Start back camera
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact:"environment" }, width:640, height:480 },
      audio: false
    });
    const video=document.getElementById("rouletteVideo");
    video.srcObject=stream;
    await video.play();
    requestAnimationFrame(analyzeFrame);
  }catch(e){
    alert("Camera access failed: "+e+"\nTrying default camera...");
    // fallback to default camera
    const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    const video=document.getElementById("rouletteVideo");
    video.srcObject=stream;
    await video.play();
    requestAnimationFrame(analyzeFrame);
  }
}

// Analyze frame for OCR and ball tracking
async function analyzeFrame(){
  const video=document.getElementById("rouletteVideo");
  const canvas=document.getElementById("canvas");
  const ctx=canvas.getContext("2d");
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  // Detect numbers from top region (adjust if needed)
  await detectNumbers(ctx);

  // Detect ball
  const ball=detectBall(ctx);
  if(ball) trackBallMotion(ball, ctx);

  // Update prediction
  updatePrediction();

  requestAnimationFrame(analyzeFrame);
}

// Detect ball as bright spot
function detectBall(ctx){
  const img=ctx.getImageData(0,0,ctx.canvas.width,ctx.canvas.height);
  for(let i=0;i<img.data.length;i+=4){
    const r=img.data[i], g=img.data[i+1], b=img.data[i+2];
    if(r>200 && g>200 && b>200){ 
      const x=(i/4)%ctx.canvas.width;
      const y=Math.floor(i/4/ctx.canvas.width);
      return {x,y};
    }
  }
  return null;
}

function trackBallMotion(ball, ctx){
  const centerX=ctx.canvas.width/2;
  const centerY=ctx.canvas.height/2;
  const now=performance.now();
  const angle=Math.atan2(ball.y-centerY, ball.x-centerX);
  if(prevAngle!==null){
    const dt=(now-prevTime)/1000;
    currentSpeed=(angle-prevAngle)/dt;
  }
  prevAngle=angle;
  prevTime=now;
}

// OCR detection
async function detectNumbers(ctx){
  const numRegion={x:ctx.canvas.width*0.4, y:ctx.canvas.height*0.05, w:ctx.canvas.width*0.2, h:ctx.canvas.height*0.08};
  const imgData=ctx.getImageData(numRegion.x, numRegion.y, numRegion.w, numRegion.h);
  const result = await Tesseract.recognize(imgData,'eng');
  const num=parseInt(result.data.text.replace(/\D/g,''));
  if(!isNaN(num) && num>=0 && num<=36){
    if(history.length==0 || history[history.length-1]!=num){
      history.push(num);
      if(history.length>100) history=history.slice(-100);
    }
  }
}

// Prediction engine
function updatePrediction(){
  if(history.length==0) return;
  const score=Array(37).fill(0);
  history.forEach((n,idx)=>{
    const decay=Math.pow(0.95, history.length-idx);
    score[n]+=3*decay;
    const idxWheel=wheel.indexOf(n);
    for(let i=-1;i<=1;i++) if(i!==0){
      const neighbor=wheel[(idxWheel+i+37)%37];
      score[neighbor]+=decay;
    }
  });

  const sorted=score.map((v,i)=>({num:i,score:v})).sort((a,b)=>b.score-a.score);
  const main=sorted[0];
  const mainIdx=wheel.indexOf(main.num);
  const neighbors=[wheel[(mainIdx+1)%37], wheel[(mainIdx-1+37)%37]];
  const topNeighbor=neighbors.sort((a,b)=>score[b]-score[a])[0];

  const top5=sorted.slice(0,5);
  const total=top5.reduce((s,n)=>s+n.score,0);

  document.getElementById("mainNumber").innerHTML=
    "<b>Main Number:</b> <span class='hot'>"+main.num+"</span>";
  document.getElementById("neighbor").innerHTML=
    "<b>Top Neighbor:</b> <span class='good'>"+topNeighbor+"</span>";
  document.getElementById("probabilities").innerHTML=
    "<b>Top 5 Numbers & Probabilities:</b><br>"+
    top5.map(n=>n.num+": "+((n.score/total)*100).toFixed(1)+"%").join("<br>");
  const strong=score[topNeighbor]>0.5*score[main.num];
  document.getElementById("confidence").innerHTML=
    strong ? "✅ Strong Confidence – Play" : "⚠️ Weak Confidence – Reduce/Skip";
}

// Start camera on page load
startCamera();
</script>
</body>
</html>
