<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Roulette Analyzer - Live Camera</title>
<style>
body { background:#000; color:#fff; font-family:Arial,sans-serif; text-align:center; margin:0; padding:0; }
header { background:#111; padding:12px; font-size:1.3em; }
#videoContainer { margin:10px auto; max-width:600px; position:relative; }
video { width:100%; border:2px solid #fff; }
button { margin:8px; padding:8px 12px; font-size:1em; }
#outputBox { margin:10px; padding:10px; background:#1a1a1a; border-radius:6px; }
#numbersDetected, #macroSector, #topNumber, #neighbor { margin:6px 0; }
</style>
</head>
<body>

<header>Mobile Roulette Analyzer</header>

<div id="videoContainer">
  <video id="camera" autoplay playsinline></video>
</div>

<button id="captureBtn">ðŸ“¸ Capture Last 100 Numbers</button>

<div id="outputBox">
  <div id="status">Waiting for captureâ€¦</div>
  <div id="numbersDetected"></div>
  <div id="macroSector"></div>
  <div id="topNumber"></div>
  <div id="neighbor"></div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
// ---- WHEEL MODEL ----
const wheel=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,
30,8,23,10,5,24,16,33,1,20,14,31,9,
22,18,29,7,28,12,35,3,26];

let lastNumbers=[];

// ---- CAMERA SETUP ----
const video=document.getElementById('camera');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');

async function startCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }, // back camera
      audio: false
    });
    video.srcObject=stream;
  } catch(err){
    alert("Camera access failed: "+err);
  }
}
startCamera();

// ---- PREPROCESS FRAME ----
function preprocessFrame(){
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  let imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  let data=imgData.data;
  // Convert to grayscale + threshold to remove red/black/green squares
  for(let i=0;i<data.length;i+=4){
    let r=data[i], g=data[i+1], b=data[i+2];
    let brightness=0.299*r+0.587*g+0.114*b;
    // Simple threshold
    data[i]=data[i+1]=data[i+2]=brightness>100?255:0;
  }
  ctx.putImageData(imgData,0,0);
}

// ---- CAPTURE & OCR ----
document.getElementById('captureBtn').addEventListener('click', async ()=>{
  document.getElementById('status').innerText="Processing...";
  preprocessFrame();
  const dataUrl=canvas.toDataURL('image/png');
  
  try{
    const result = await Tesseract.recognize(dataUrl,'eng',{
      logger:m=>console.log(m)
    });
    let nums = result.data.text.match(/\b([0-9]|[1-2][0-9]|3[0-6])\b/g);
    if(!nums || nums.length<50) return alert("OCR failed, show clear numbers.");
    nums = nums.map(Number).slice(-100); // last 100 numbers
    lastNumbers=nums;
    document.getElementById('numbersDetected').innerText="Detected Numbers: "+nums.join(", ");
    runPrediction(nums);
  } catch(e){
    alert("OCR failed: "+e);
  }
});

// ---- PREDICTION LOGIC ----
function runPrediction(history){
  // --- Macro Sector Top 3 ---
  const heat=Array(37).fill(0);
  history.forEach(n=>{
    const idx=wheel.indexOf(n);
    for(let i=-2;i<=2;i++) heat[(idx+i+37)%37]++;
  });
  let topSector=[];
  for(let i=0;i<3;i++){
    let max=Math.max(...heat);
    let idx=heat.indexOf(max);
    topSector.push(wheel[idx]);
    heat[idx]=0; // remove from next pick
  }
  document.getElementById('macroSector').innerText="Macro Sector (Top 3): "+topSector.join(", ");
  
  // --- Top Number & Neighbor ---
  let freq={};
  history.forEach(n=>freq[n]=(freq[n]||0)+1);
  let topNum=parseInt(Object.keys(freq).reduce((a,b)=>freq[a]>freq[b]?a:b));
  let idx=wheel.indexOf(topNum);
  let neighbor=wheel[(idx+1)%37]; // 1 neighbor
  document.getElementById('topNumber').innerText="Top Number: "+topNum;
  document.getElementById('neighbor').innerText="Neighbor: "+neighbor;
  
  document.getElementById('status').innerText="Prediction ready âœ…";
}
</script>

</body>
</html>
